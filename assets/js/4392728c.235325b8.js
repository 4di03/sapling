"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[5861],{3905:(e,n,t)=>{t.r(n),t.d(n,{MDXContext:()=>l,MDXProvider:()=>u,mdx:()=>x,useMDXComponents:()=>p,withMDXComponents:()=>m});var i=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(){return o=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},o.apply(this,arguments)}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function d(e,n){if(null==e)return{};var t,i,a=function(e,n){if(null==e)return{};var t,i,a={},o=Object.keys(e);for(i=0;i<o.length;i++)t=o[i],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)t=o[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var l=i.createContext({}),m=function(e){return function(n){var t=p(n.components);return i.createElement(e,o({},n,{components:t}))}},p=function(e){var n=i.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},u=function(e){var n=p(e.components);return i.createElement(l.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},h=i.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,l=d(e,["components","mdxType","originalType","parentName"]),m=p(t),u=a,h=m["".concat(s,".").concat(u)]||m[u]||c[u]||o;return t?i.createElement(h,r(r({ref:n},l),{},{components:t})):i.createElement(h,r({ref:n},l))}));function x(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,s=new Array(o);s[0]=h;var r={};for(var d in n)hasOwnProperty.call(n,d)&&(r[d]=n[d]);r.originalType=e,r.mdxType="string"==typeof e?e:a,s[1]=r;for(var l=2;l<o;l++)s[l]=t[l];return i.createElement.apply(null,s)}return i.createElement.apply(null,t)}h.displayName="MDXCreateElement"},81393:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>p,frontMatter:()=>o,metadata:()=>r,toc:()=>l});var i=t(83117),a=(t(67294),t(3905));const o={},s="Writing Tests",r={unversionedId:"dev/process/writing_tests",id:"dev/process/writing_tests",title:"Writing Tests",description:"For different languages, or purposes, there are different ways to write tests.",source:"@site/docs/dev/process/writing_tests.md",sourceDirName:"dev/process",slug:"/dev/process/writing_tests",permalink:"/docs/dev/process/writing_tests",draft:!1,editUrl:"https://github.com/facebook/sapling/tree/main/website/docs/dev/process/writing_tests.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"ZstDelta",permalink:"/docs/dev/internals/zstdelta"}},d={},l=[{value:"<code>.t</code> Tests",id:"t-tests",level:2},{value:"Basic",id:"basic",level:3},{value:"Best practice",id:"best-practice",level:3},{value:"Recommended test setup",id:"recommended-test-setup",level:4},{value:"Create a new repo for each sub-test-case",id:"create-a-new-repo-for-each-sub-test-case",level:4},{value:"Running tests against Watchman or EdenFS",id:"running-tests-against-watchman-or-edenfs",level:4},{value:"Silence uninteresting output",id:"silence-uninteresting-output",level:4},{value:"Use drawdag to create commits",id:"use-drawdag-to-create-commits",level:4},{value:"Avoid depending on context",id:"avoid-depending-on-context",level:4},{value:"Advanced features",id:"advanced-features",level:3},{value:"Test environment",id:"test-environment",level:4},{value:"Conditional logic",id:"conditional-logic",level:4},{value:"Multiple test cases",id:"multiple-test-cases",level:4},{value:"Hybrid Python code blocks",id:"hybrid-python-code-blocks",level:4},{value:"Processing previous command output in Python",id:"processing-previous-command-output-in-python",level:4},{value:"Matching dynamic output",id:"matching-dynamic-output",level:4},{value:"Available commands and binaries",id:"available-commands-and-binaries",level:4},{value:"Test-level settings",id:"test-level-settings",level:4},{value:"Rust tests",id:"rust-tests",level:2},{value:"Python tests",id:"python-tests",level:2}],m={toc:l};function p(e){let{components:n,...t}=e;return(0,a.mdx)("wrapper",(0,i.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,a.mdx)("h1",{id:"writing-tests"},"Writing Tests"),(0,a.mdx)("p",null,"For different languages, or purposes, there are different ways to write tests."),(0,a.mdx)("p",null,"Unit tests, and doctests are generally good choices for Rust. The\n",(0,a.mdx)("inlineCode",{parentName:"p"},"sapling/")," Python API is not stable, and things are coupled too much\n(ex. the Python bookmark store ",(0,a.mdx)("inlineCode",{parentName:"p"},"bmstore")," object cannot be created without an\nrepo object). Therefore Python unit tests only make more sense for logic\nthat is relatively independent."),(0,a.mdx)("p",null,"Sapling also has a unique kind of tests - ",(0,a.mdx)("inlineCode",{parentName:"p"},".t")," tests. It is a good fit for\ntesting end-user command-line experience."),(0,a.mdx)("h2",{id:"t-tests"},(0,a.mdx)("inlineCode",{parentName:"h2"},".t")," Tests"),(0,a.mdx)("p",null,(0,a.mdx)("inlineCode",{parentName:"p"},".t")," tests live in ",(0,a.mdx)("inlineCode",{parentName:"p"},"tests/"),". They can be run by\n",(0,a.mdx)("inlineCode",{parentName:"p"},"run-tests.py <.t file name>"),"."),(0,a.mdx)("h3",{id:"basic"},"Basic"),(0,a.mdx)("p",null,"Each test looks like indented blocks of bash scripts with commentary.\nFor example"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"Test 'echo' works. This line is a comment.\n\n  $ echo A\n  A\n")),(0,a.mdx)("p",null,"The test engine will execute ",(0,a.mdx)("inlineCode",{parentName:"p"},"echo A")," and verify its output is ",(0,a.mdx)("inlineCode",{parentName:"p"},"A"),"."),(0,a.mdx)("p",null,"The ",(0,a.mdx)("inlineCode",{parentName:"p"},".t")," format also supports multi-line commands, Python scripts and\ntesting exit code:"),(0,a.mdx)("p",null,"Multi-line commands (with heredoc):"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"  $ sha1sum << EOF\n  > hello\n  > EOF\n  f572d396fae9206628714fb2ce00f72e94f2258f\n")),(0,a.mdx)("p",null,"Python code blocks:"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},'  >>> import sys\n  >>> for i in "hello world".split():\n  ...     sys.stdout.write("%s\\n" % i)\n  hello\n  world\n')),(0,a.mdx)("p",null,"Exit code can be tested using ","[code]",":"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"  $ false\n  [1]\n")),(0,a.mdx)("p",null,"To get started with creating a test, you can set ",(0,a.mdx)("inlineCode",{parentName:"p"},"PS1='$ '")," in your shell\nand experiment with the reproducing commands. When done, just copy them to\na ",(0,a.mdx)("inlineCode",{parentName:"p"},".t")," file and prefix them with two spaces."),(0,a.mdx)("p",null,"You can also just edit the ",(0,a.mdx)("inlineCode",{parentName:"p"},"$")," command lines in ",(0,a.mdx)("inlineCode",{parentName:"p"},"test-foo.t")," directly, and\nuse ",(0,a.mdx)("inlineCode",{parentName:"p"},"run-tests.py -i test-foo.t")," to fill in the output. This is also a good\nway to edit tests."),(0,a.mdx)("h3",{id:"best-practice"},"Best practice"),(0,a.mdx)("h4",{id:"recommended-test-setup"},"Recommended test setup"),(0,a.mdx)("p",null,"tl;dr: Write tests as follows:"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"  $ newclientrepo <<'EOS'\n  > B\n  > |\n  > A\n  > EOS\n\nThis is a comment\n  $ touch something\n  $ hg st # this is another comment\n  ? something\n  $ hg go $A -q\n")),(0,a.mdx)("p",null,(0,a.mdx)("strong",{parentName:"p"},"The recommended way to create new repos is to use ",(0,a.mdx)("inlineCode",{parentName:"strong"},"newclientrepo")),"."),(0,a.mdx)("p",null,"By default new tests test against:"),(0,a.mdx)("ul",null,(0,a.mdx)("li",{parentName:"ul"},"Sapling without Watchman"),(0,a.mdx)("li",{parentName:"ul"},"Sapling and Watchman"),(0,a.mdx)("li",{parentName:"ul"},"Sapling and EdenFS")),(0,a.mdx)("p",null,"If it's necessary to specify just one of them, ",(0,a.mdx)("inlineCode",{parentName:"p"},"#require eden")," / ",(0,a.mdx)("inlineCode",{parentName:"p"},"#require no-eden")," / ",(0,a.mdx)("inlineCode",{parentName:"p"},"#require fsmonitor")," / ",(0,a.mdx)("inlineCode",{parentName:"p"},"#require no-fsmonitor"),"\ncan be added at the top of the file for specifying only one of them."),(0,a.mdx)("h4",{id:"create-a-new-repo-for-each-sub-test-case"},"Create a new repo for each sub-test-case"),(0,a.mdx)("p",null,"Creating a new repo is a very cheap operation and can help untangle future\nissues caused by overusing the same one. It's possible to specify the names of\nnew repos when using ",(0,a.mdx)("inlineCode",{parentName:"p"},"newclientrepo"),"; the name of the server for the repo can\nalso be specified. For example:"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"  $ newclientrepo\n  $ pwd # the name of the repo is repo<N> by default\n  $TESTTMP/repo1\n  $ hg config paths.default # similarly, the repo names are repo<N>\n  test:repo1_server\n")),(0,a.mdx)("h4",{id:"running-tests-against-watchman-or-edenfs"},"Running tests against Watchman or EdenFS"),(0,a.mdx)("p",null,"Currently these two can only be run through Buck. ",(0,a.mdx)("inlineCode",{parentName:"p"},"-")," and ",(0,a.mdx)("inlineCode",{parentName:"p"},".")," in test names have\nto be converted to ",(0,a.mdx)("inlineCode",{parentName:"p"},"_"),". For instance,"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"# Runs test-rust-checkout.t with Watchman enabled\n$ buck2 test '@fbcode//mode/opt' :hg_watchman_run_tests -- test_rust_checkout_t\n\n# Runs test-rust-checkout.t with EdenFS enabled\n$ buck2 test '@fbcode//mode/opt' :hg_edenfs_run_tests -- test_rust_checkout_t\n")),(0,a.mdx)("p",null,"On EdenFS tests the EdenFS CLI is available throug the ",(0,a.mdx)("inlineCode",{parentName:"p"},"eden")," command; it's\nrecommended for new repos (cloned or newly created) to be created through\n",(0,a.mdx)("inlineCode",{parentName:"p"},"newclientrepo"),". See the previous section for an example on how to do this."),(0,a.mdx)("h4",{id:"silence-uninteresting-output"},"Silence uninteresting output"),(0,a.mdx)("p",null,"Not all output is interesting to the test. For example, when testing\n",(0,a.mdx)("inlineCode",{parentName:"p"},"hg log"),", the output of ",(0,a.mdx)("inlineCode",{parentName:"p"},"hg update")," is not interesting. Use ",(0,a.mdx)("inlineCode",{parentName:"p"},"-q"),"\nto silence it"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"  $ hg update -q commit-x\n")),(0,a.mdx)("p",null,"This makes the test cleaner and easier to codemod ",(0,a.mdx)("inlineCode",{parentName:"p"},"update")," output."),(0,a.mdx)("p",null,"Similarity, avoid testing revision numbers, or branch names, if they are not\ninteresting to the test. It will make deprecation of those features easier."),(0,a.mdx)("h4",{id:"use-drawdag-to-create-commits"},"Use drawdag to create commits"),(0,a.mdx)("p",null,(0,a.mdx)("inlineCode",{parentName:"p"},"hg debugdrawdag")," (or ",(0,a.mdx)("inlineCode",{parentName:"p"},"drawdag")," defined in ",(0,a.mdx)("inlineCode",{parentName:"p"},"tinit.sh"),") can be used to\ncreate commits in a more readable, and efficient way. ",(0,a.mdx)("inlineCode",{parentName:"p"},"newclientrepo")," (also\ndefined on ",(0,a.mdx)("inlineCode",{parentName:"p"},"tinit.sh"),") can also take the same input as ",(0,a.mdx)("inlineCode",{parentName:"p"},"drawdag"),". See\n",(0,a.mdx)("a",{parentName:"p",href:"../internals/drawdag"},"the drawdag page")," for more info."),(0,a.mdx)("h4",{id:"avoid-depending-on-context"},"Avoid depending on context"),(0,a.mdx)("p",null,"As the test file grows longer, it could become difficult to follow or modify.\nIt's often caused by commands depending on the context (ex. the current repo\nstate, or the current directory) and the context is not obvious by just\nreading the code. Here are some tips to make tests easier to understand:"),(0,a.mdx)("ul",null,(0,a.mdx)("li",{parentName:"ul"},"Avoid ",(0,a.mdx)("inlineCode",{parentName:"li"},"..")," in filesystem paths. Instead of ",(0,a.mdx)("inlineCode",{parentName:"li"},"cd ../repo1"),",\nuse ",(0,a.mdx)("inlineCode",{parentName:"li"},"cd $TESTTMP/repo1"),"."),(0,a.mdx)("li",{parentName:"ul"},"Avoid using a list of ",(0,a.mdx)("inlineCode",{parentName:"li"},"hg commit"),", ",(0,a.mdx)("inlineCode",{parentName:"li"},"hg update")," to create a repo.\nUse drawdag if possible. If drawdag cannot be used, insert a ",(0,a.mdx)("inlineCode",{parentName:"li"},"hg log -G"),"\ncommand to print the repo content out.")),(0,a.mdx)("h3",{id:"advanced-features"},"Advanced features"),(0,a.mdx)("h4",{id:"test-environment"},"Test environment"),(0,a.mdx)("p",null,"A test starts inside a temporary directory, which can be obtained using\n",(0,a.mdx)("inlineCode",{parentName:"p"},"TESTTMP")," environment variable. The ",(0,a.mdx)("inlineCode",{parentName:"p"},"TESTDIR")," environment variable contains\nthe path to the ",(0,a.mdx)("inlineCode",{parentName:"p"},"tests/")," directory, which can be handy to refer to other\nscripts."),(0,a.mdx)("p",null,(0,a.mdx)("inlineCode",{parentName:"p"},"tests/tinit.sh")," is sourced. Functions defined in it can be used to make\ntests shorter. For example"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"Use functions in tinit.sh:\n  $ setconfig lfs.url=file://$TESTTMP/lfs lfs.threshold=10B\n  $ enable lfs rebase\n  $ newrepo\n")),(0,a.mdx)("p",null,"Equivalent to:"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"  $ cat >> $HGRCPATH << EOF\n  > [extensions]\n  > lfs=\n  > rebase=\n  > [lfs]\n  > url=file://$TESTTMP/lfs\n  > threshold=10B\n  > EOF\n  $ hg init repo1\n  $ cd repo1\n")),(0,a.mdx)("p",null,"A particularly important function is ",(0,a.mdx)("inlineCode",{parentName:"p"},"newclientrepo"),". It also allows specifying\ndifferent repo and server names:"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"  $ newclientrepo foo\n  $ newclientrepo bar test:customservername\n  $ cd $TESTTMP/foo # this goes back to the foo repo\n")),(0,a.mdx)("p",null,"Similarly, there are some default Sapling configs defined in\n",(0,a.mdx)("inlineCode",{parentName:"p"},"tests/default_hgrc.py"),". These defaults change depending on whether tests are\ncompatible with ",(0,a.mdx)("inlineCode",{parentName:"p"},"debugruntest")," or not."),(0,a.mdx)("h4",{id:"conditional-logic"},"Conditional logic"),(0,a.mdx)("p",null,"Certain tests might require some features (ex. POSIX, case insensitive\nfilesystem, or certain programs to be installed). Run ",(0,a.mdx)("inlineCode",{parentName:"p"},"python tests/hghave\n--list")," to get a list of features that can be tested. Example use in ",(0,a.mdx)("inlineCode",{parentName:"p"},".t"),"\nlooks like"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"#require fsmonitor icasefs\nThe test will be skipped if any of the requirement is not sastified.\n\n#if symlink\nThis block is skipped if symlink is not supported.\n  $ ln -s a b\n#else\nThis block is skipped if symlink is supported.\n  $ cp a b\n#endif\n")),(0,a.mdx)("p",null,'"If" statements can be nested as well and multiple statements can be put in a\nsingle statement:'),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"#if symlink no-osx\nThis block will only be run if symlinks are supported and macOS is not being used\n  $ ln -s a b\n\n#if execbit\nThis block will only be run if symlinks are supported, macOS is not being used, and execbit is supported\n  $ chmod +x a\n#endif\n\n#else\nThis block will only be run if symlinks are not supported or macOS is being used\n  $ cp a b\n#endif\n")),(0,a.mdx)("p",null,"Features can be prefixed with ",(0,a.mdx)("inlineCode",{parentName:"p"},"no-")," meaning it should not be selected"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"#require no-fsmonitor\nSkip this test on 'run-tests.py --watchman'.\n")),(0,a.mdx)("h4",{id:"multiple-test-cases"},"Multiple test cases"),(0,a.mdx)("p",null,"Sometimes it's feasible to reuse the most of the test code for different code\npaths. ",(0,a.mdx)("inlineCode",{parentName:"p"},"#testcases")," can be used to define test case names that can be used\nfor feature testing"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"#testcases innodb rocksdb\n\n#if innodb\n  $ setconfig db.engine=inno\n#else\n  $ setconfig db.engine=rocks\n#endif\n")),(0,a.mdx)("p",null,"This runs the test once for each test case."),(0,a.mdx)("h4",{id:"hybrid-python-code-blocks"},"Hybrid Python code blocks"),(0,a.mdx)("p",null,"If using ",(0,a.mdx)("inlineCode",{parentName:"p"},"debugruntest"),", it's possible to combine Python code blocks with\nshell-like input. For instance,"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"    if True:\n      $ echo 1\n      1\n")),(0,a.mdx)("h4",{id:"processing-previous-command-output-in-python"},"Processing previous command output in Python"),(0,a.mdx)("p",null,"Sometimes it can be useful to process some command's output on Python rather\nthan just to expect some value. If ",(0,a.mdx)("inlineCode",{parentName:"p"},"debugruntest")," is used, last command's output\ncan is stored in the ",(0,a.mdx)("inlineCode",{parentName:"p"},"_")," variable in Python. For example,"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},'  $ echo 123\n  123\n  >>> _ == "123\\n"\n  True\n  >>> assert _ == "True\\n"\n')),(0,a.mdx)("h4",{id:"matching-dynamic-output"},"Matching dynamic output"),(0,a.mdx)("p",null,"To filter noisy output that changes on each run (ex. timestamps), use glob\npatterns and put a space and ",(0,a.mdx)("inlineCode",{parentName:"p"},"(glob)")," at the end of the output line"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"  $ hg parents -r null --time\n  time: real * secs (user * sys *) (glob)\n")),(0,a.mdx)("p",null,"In the same vein, regular expressions can be also used with ",(0,a.mdx)("inlineCode",{parentName:"p"},"(re)"),":"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},'  $ echo "   3"\n  \\s*3 (re)\n')),(0,a.mdx)("p",null,"Escape sequences can be expected as well:"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},'  $ hg debugtemplate \'{label(\\"test.test\\", \\"output\\n\\")}\' --config color.test.test=blue\n  \\x1b[34moutput\\x1b[39m (esc)\n')),(0,a.mdx)("p",null,"You can match different output based on which features are available. Use\n",(0,a.mdx)("inlineCode",{parentName:"p"},"(feature-name !)")," to mark a line as required if the feature was turned on,\nor optional otherwise."),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"  $ hg debugfsinfo | grep eden\n  fstype: eden (eden !)\n")),(0,a.mdx)("p",null,'More than one feature can be expected here (all of them will be "and"-end), and\nglobs can be used as well:'),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},'  $ hg go $B\n  update failed to remove foo: Can\'t remove file "*foo": The process cannot access the file because it is being used by another process. (os error 32)! (glob) (windows !) (no-eden !)\n  2 files updated, 0 files merged, 1 files removed, 0 files unresolved\n')),(0,a.mdx)("p",null,"Use ",(0,a.mdx)("inlineCode",{parentName:"p"},"(?)")," to mark output as optional unconditionally"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"  $ maybe-output-foobar\n  foobar (?)\n")),(0,a.mdx)("p",null,"There is an additional mechanism for matching output more or less arbitrarily;\nthis is done through ",(0,a.mdx)("inlineCode",{parentName:"p"},"registerfallbackmatch"),", and this is what ",(0,a.mdx)("inlineCode",{parentName:"p"},".t")," tests to be\nok with non-EdenFS and EdenFS outputs from ",(0,a.mdx)("inlineCode",{parentName:"p"},"hg goto"),". That makes"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"  $ hg goto foo\n  2 files updated, 0 files merged, 1 files removed, 0 files unresolved\n")),(0,a.mdx)("p",null,"work without having to resort to"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"#if no-eden\n  $ hg goto foo\n  2 files updated, 0 files merged, 1 files removed, 0 files unresolved\n#else\n  $ hg goto foo\n  update complete\n#endif\n")),(0,a.mdx)("h4",{id:"available-commands-and-binaries"},"Available commands and binaries"),(0,a.mdx)("p",null,"For making a test only run if a certain binary is available, the ",(0,a.mdx)("inlineCode",{parentName:"p"},"#require"),"\nstatements, ",(0,a.mdx)("inlineCode",{parentName:"p"},"#if")," blocks, or ",(0,a.mdx)("inlineCode",{parentName:"p"},"( !)")," line matching can be used. For instance,"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"#require git\n\n  $ git --version | wc -l 1\n  1\n\n#if node\n  $ node --version | wc -l 1\n  1\n#endif\n\n  $ lldb -P 2>&1 | wc -l 1\n  1 (lldb !)\n  [255] (no-lldb !)\n")),(0,a.mdx)("p",null,"As mentioned previously, there are two different engines for .t tests."),(0,a.mdx)("p",null,"On the old test engine, commands are run using Bash on macOS and Linux, and\nall usual commands (",(0,a.mdx)("inlineCode",{parentName:"p"},"ls"),", ",(0,a.mdx)("inlineCode",{parentName:"p"},"echo"),") are the ones that the new test engine\nimplements. For other binaries (e.g., ",(0,a.mdx)("inlineCode",{parentName:"p"},"git"),", ",(0,a.mdx)("inlineCode",{parentName:"p"},"unzip"),", etc.) the ones provided\nby the system are used; whichever commands are in ",(0,a.mdx)("inlineCode",{parentName:"p"},"PATH")," can actually be used."),(0,a.mdx)("p",null,"In the case of ",(0,a.mdx)("inlineCode",{parentName:"p"},"debugruntest")," tests, Bash is not actually used and Shell\nbuiltins / coreutils are implemented by the test runner. Additionally, certain\ncommands such as ",(0,a.mdx)("inlineCode",{parentName:"p"},"unzip")," are actually implemented within the test runner itself.\nThis is done for improving compatibility with non-POSIX OSes and for performance\nreasons."),(0,a.mdx)("h4",{id:"test-level-settings"},"Test-level settings"),(0,a.mdx)("p",null,"Currently we have four test-level settings:"),(0,a.mdx)("ul",null,(0,a.mdx)("li",{parentName:"ul"},(0,a.mdx)("inlineCode",{parentName:"li"},"#debugruntest-incompatible")," :: Makes the test use the legacy test engine."),(0,a.mdx)("li",{parentName:"ul"},(0,a.mdx)("inlineCode",{parentName:"li"},"#inprocess-hg-incompatible")," :: To be used on ",(0,a.mdx)("inlineCode",{parentName:"li"},"debugruntest")," tests. Without\nthis, a new Sapling process is used every time Sapling is invoked in ",(0,a.mdx)("inlineCode",{parentName:"li"},".t"),"\ntests. There are a few more caveats, see the documentation under\n",(0,a.mdx)("inlineCode",{parentName:"li"},"scm/sapling/testing"),"."),(0,a.mdx)("li",{parentName:"ul"},(0,a.mdx)("inlineCode",{parentName:"li"},"#chg-compatible")," ::  To be used on non-",(0,a.mdx)("inlineCode",{parentName:"li"},"debugruntest")," tests. This is similar\nto ",(0,a.mdx)("em",{parentName:"li"},"not")," using ",(0,a.mdx)("inlineCode",{parentName:"li"},"#inprocess-hg-incompatible")," from above, making ",(0,a.mdx)("inlineCode",{parentName:"li"},".t")," tests use\nthe ",(0,a.mdx)("inlineCode",{parentName:"li"},"chg")," daemon for Sapling processes."),(0,a.mdx)("li",{parentName:"ul"},(0,a.mdx)("inlineCode",{parentName:"li"},"#modern-config-incompatible")," :: Only compatible with ",(0,a.mdx)("inlineCode",{parentName:"li"},"debugruntest")," tests and\n",(0,a.mdx)("strong",{parentName:"li"},"not*")," intended te be used on new tests. This exists for legacy reasons,\nmaking tests use much older configs by default.")),(0,a.mdx)("h2",{id:"rust-tests"},"Rust tests"),(0,a.mdx)("p",null,"Follow the Rust community standard."),(0,a.mdx)("p",null,"For modules that are likely to be used by other developers, Rustdoc is a good\nchoice to show examples about how to use a function. Especially when it's not\nobvious."),(0,a.mdx)("p",null,"For native Rust code, prefer unit tests inside modules"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre"},"/* module code */\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_feature_x() {\n        assert!(...);\n    }\n}\n")),(0,a.mdx)("p",null,"Use ",(0,a.mdx)("inlineCode",{parentName:"p"},"tests/")," for independent integration tests, and ",(0,a.mdx)("inlineCode",{parentName:"p"},"benches/")," for\nbenchmarks."),(0,a.mdx)("h2",{id:"python-tests"},"Python tests"),(0,a.mdx)("p",null,(0,a.mdx)("inlineCode",{parentName:"p"},"run-tests.py")," supports not only ",(0,a.mdx)("inlineCode",{parentName:"p"},".t")," tests, but also standard Python unit\ntests in ",(0,a.mdx)("inlineCode",{parentName:"p"},".py")," files. See ",(0,a.mdx)("inlineCode",{parentName:"p"},"test-lock.py")," for an example."),(0,a.mdx)("p",null,"Python functions can have doctests, run by ",(0,a.mdx)("inlineCode",{parentName:"p"},"run-tests.py test-doctest.py"),".\nSee ",(0,a.mdx)("a",{parentName:"p",href:"https://github.com/facebook/sapling/commit/D8221079"},(0,a.mdx)("inlineCode",{parentName:"a"},"D822107"))," for an example."))}p.isMDXComponent=!0}}]);